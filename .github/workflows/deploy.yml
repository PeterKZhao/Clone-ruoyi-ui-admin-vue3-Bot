name: Clone, Replace & Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:  # 允许手动触发

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # ── Step 1: 克隆 Gitee 源码 ──────────────────────────────────────
      - name: Clone from Gitee
        run: |
          git clone https://gitee.com/yudaocode/yudao-ui-admin-vue3.git source
          echo "✅ Gitee 克隆完成"

      # ── Step 2: 批量替换文本内容 ──────────────────────────────────────
      - name: Replace text content
        run: |
          cd source

          # 定义需要替换的文件类型（排除 .git 目录）
          FILE_TYPES=("*.vue" "*.ts" "*.js" "*.json" "*.md" "*.html" "*.css" "*.scss" "*.env" "*.env.*" "*.yaml" "*.yml" "*.txt")

          replace_in_files() {
            for ext in "${FILE_TYPES[@]}"; do
              find . -not -path './.git/*' -name "$ext" -type f | while read -r file; do
                sed -i \
                  -e 's|http://api-dashboard\.yudao\.iocoder\.cn|http://114.55.24.12:48080|g' \
                  -e 's|RuoYi|Future|g' \
                  -e 's|Yudao|Future|g' \
                  -e 's|Ruoyi|Future|g' \
                  -e 's|yudao|future|g' \
                  -e 's|ruoyi|future|g' \
                  "$file"
              done
            done
          }

          replace_in_files
          echo "✅ 文本替换完成"

      # ── Step 3: 安装 Node.js ─────────────────────────────────────────
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: source/package-lock.json

      # ── Step 4: 安装依赖 ──────────────────────────────────────────────
      - name: Install dependencies
        run: |
          cd source
          npm install --legacy-peer-deps
          echo "✅ 依赖安装完成"

      # ── Step 5: 编译构建 ──────────────────────────────────────────────
      - name: Build
        run: |
          cd source
          npm run build
          echo "✅ 构建完成"

      # ── Step 6: 配置 GitHub Pages base 路径（重要！）────────────────
      # yudao-ui-admin-vue3 使用 Vite，需确保 vite.config.ts 中 base 与仓库名一致
      # 若仓库名为 future-ui-admin-vue3，构建产物路径需匹配
      # 如构建产物在 dist/ 目录，以下步骤直接部署

      # ── Step 7: 上传构建产物 ─────────────────────────────────────────
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: source/dist

      # ── Step 8: 发布到 GitHub Pages ──────────────────────────────────
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
