name: Clone, Replace & Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # ── Step 1: 克隆 Gitee 源码 ──────────────────────────────────────
      - name: Clone from Gitee
        run: |
          git clone https://gitee.com/yudaocode/yudao-ui-admin-vue3.git source

      # ── Step 2: 批量替换文本内容 ──────────────────────────────────────
      - name: Replace text content
        run: |
          cd source
          FILE_TYPES=("*.vue" "*.ts" "*.js" "*.json" "*.md" "*.html" "*.css" "*.scss" "*.env" "*.yaml" "*.yml" "*.txt")
          for ext in "${FILE_TYPES[@]}"; do
            find . -not -path './.git/*' -name "$ext" -type f | while read -r file; do
              sed -i \
                -e 's|http://api-dashboard\.yudao\.iocoder\.cn|http://114.55.24.12:48080|g' \
                -e 's|RuoYi|Future|g' \
                -e 's|Yudao|Future|g' \
                -e 's|Ruoyi|Future|g' \
                -e 's|yudao|future|g' \
                -e 's|ruoyi|future|g' \
                "$file"
            done
          done
          echo "✅ 文本替换完成"

      # ── Step 3: 安装 Node.js ─────────────────────────────────────────
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ── Step 4: 安装 pnpm（项目强制要求）────────────────────────────
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      # ── Step 5: 配置 pnpm 缓存 ───────────────────────────────────────
      - name: Get pnpm store directory
        id: pnpm-cache
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm modules
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('source/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      # ── Step 6: 安装依赖 ──────────────────────────────────────────────
      - name: Install dependencies
        run: |
          cd source
          pnpm install --no-frozen-lockfile
          echo "✅ 依赖安装完成"

      # ── Step 7: 编译构建（使用 build:prod 脚本）──────────────────────
      - name: Build
        run: |
          cd source
          pnpm build:prod
          echo "✅ 构建完成"

      # ── Step 8: 上传构建产物 ─────────────────────────────────────────
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: source/dist

      # ── Step 9: 发布到 GitHub Pages ──────────────────────────────────
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
